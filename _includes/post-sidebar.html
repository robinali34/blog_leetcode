<aside class="post-sidebar">
  <!-- Table of Contents -->
  <div class="sidebar-section toc-section">
    <h3 class="sidebar-title">Contents</h3>
    <nav class="table-of-contents" id="toc">
      <!-- TOC will be generated by JavaScript -->
    </nav>
  </div>

  <!-- Related Posts -->
  <div class="sidebar-section related-posts-section">
    <h3 class="sidebar-title">Related Posts</h3>
    <ul class="related-posts-list">
      {%- assign related_count = 0 -%}
      {%- assign max_related = 5 -%}
      {%- for post in site.posts -%}
        {%- if post.url != page.url and related_count < max_related -%}
          {%- assign common_categories = 0 -%}
          {%- for category in page.categories -%}
            {%- if post.categories contains category -%}
              {%- assign common_categories = common_categories | plus: 1 -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if common_categories > 0 -%}
            <li class="related-post-item">
              <a href="{{ post.url | relative_url }}" class="related-post-link">
                <span class="related-post-title">{{ post.title | escape }}</span>
                <span class="related-post-date">{{ post.date | date: "%b %d, %Y" }}</span>
              </a>
            </li>
            {%- assign related_count = related_count | plus: 1 -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if related_count == 0 -%}
        <li class="related-post-item">
          <span class="no-related-posts">No related posts found</span>
        </li>
      {%- endif -%}
    </ul>
  </div>

  <!-- Quick Navigation -->
  <div class="sidebar-section quick-nav-section">
    <h3 class="sidebar-title">Quick Links</h3>
    <nav class="quick-nav">
      <a href="{{ '/' | relative_url }}" class="quick-nav-link">Home</a>
      <a href="{{ '/leetcode-questions-list/' | relative_url }}" class="quick-nav-link">All Problems</a>
      <a href="{{ '/posts/' | relative_url }}" class="quick-nav-link">All Posts</a>
    </nav>
  </div>
</aside>

<script>
// Generate Table of Contents
(function() {
  const content = document.querySelector('.post-content');
  if (!content) return;

  const headings = content.querySelectorAll('h2, h3, h4');
  if (headings.length === 0) {
    document.querySelector('.toc-section').style.display = 'none';
    return;
  }

  const toc = document.getElementById('toc');
  const tocList = document.createElement('ul');
  tocList.className = 'toc-list';

  headings.forEach((heading, index) => {
    // Create ID if doesn't exist
    if (!heading.id) {
      heading.id = 'heading-' + index;
    }

    const listItem = document.createElement('li');
    listItem.className = 'toc-item toc-' + heading.tagName.toLowerCase();

    const link = document.createElement('a');
    link.href = '#' + heading.id;
    link.textContent = heading.textContent;
    link.className = 'toc-link';

    // Smooth scroll
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const target = document.getElementById(heading.id);
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Update URL without jumping
        window.history.pushState(null, null, '#' + heading.id);
      }
    });

    listItem.appendChild(link);
    tocList.appendChild(listItem);
  });

  toc.appendChild(tocList);

  // Highlight active section
  const observerOptions = {
    root: null,
    rootMargin: '-20% 0px -70% 0px',
    threshold: 0
  };

  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        const activeLink = toc.querySelector('a[href="#' + id + '"]');
        if (activeLink) {
          // Remove previous active
          toc.querySelectorAll('.toc-link.active').forEach(link => {
            link.classList.remove('active');
          });
          // Add active to current
          activeLink.classList.add('active');
        }
      }
    });
  }, observerOptions);

  headings.forEach(heading => {
    observer.observe(heading);
  });
})();
</script>

